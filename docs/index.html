<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libzpc: Introduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libzpc<span id="projectnumber">&#160;1.4</span>
   </div>
   <div id="projectbrief">IBM Z Protected-key Crypto library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Introduction </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="index"></a></p>
<p>The IBM Z Protected-key Crypto library <code>libzpc</code> is an open-source library targeting the 64-bit Linux on IBM Z (s390x) platform. It provides interfaces for cryptographic primitives. The underlying implementations make use of z/Architecture's extensive performance-boosting hardware support and its <em>protected-key</em> feature which ensures that key material is never present in main memory at any time.</p>
<p>The <code>libzpc</code> source is hosted on <a href="https://github.com/opencryptoki/libzpc">GitHub</a>.</p>
<h1><a class="anchor" id="autotoc_md0"></a>
Supported crypto</h1>
<p>Encryption (Cipher): </p><pre class="fragment">AES-128-ECB, AES-192-ECB, AES-256-ECB
AES-128-CBC, AES-192-CBC, AES-256-CBC
AES-128-XTS, AES-256-XTS
</pre><p> Message authentication (MAC): </p><pre class="fragment">AES-128-CMAC, AES-192-CMAC, AES-256-CMAC
</pre><p> Hash-based message authentication (HMAC) </p><pre class="fragment">HMAC-SHA-224, HMAC-SHA-256, HMAC-SHA-384, HMAC-SHA-512
</pre><p> Authenticated Encryption (AEAD): </p><pre class="fragment">AES-128-CCM, AES-192-CCM, AES-256-CCM
AES-128-GCM, AES-192-GCM, AES-256-GCM
</pre><p> Elliptic-curve digital signature create/verify (ECDSA): </p><pre class="fragment">prime256, oid = 1.2.840.10045.3.1.7
secp384, oid = 1.3.132.0.34
secp521, oid = 1.3.132.0.35
ed25519, oid = 1.3.101.112
ed448, oid = 1.3.101.113
</pre> <h1><a class="anchor" id="autotoc_md1"></a>
Building</h1>
<p>Basic prerequisites for building the library only:</p><ul>
<li>Linux kernel &gt;= 5.7</li>
<li>C99 compiler (clang, gcc)</li>
<li>libpthread</li>
<li>cmake &gt;= 3.10</li>
<li>make</li>
</ul>
<p>Additional prerequisites for building the test program:</p><ul>
<li>C++11 compiler (clang, g++)</li>
<li>libjson-c devel package &gt;= 0.13</li>
<li>internet connection</li>
</ul>
<p>Additional prerequisites for building the html and latex doc:</p><ul>
<li>doxygen &gt;= 1.8.17</li>
<li>latex, bibtex</li>
</ul>
<p>Additional hardware and software prerequisites for ECDSA:</p><ul>
<li>Message security assist (MSA) 9 (IBM z15 or later)</li>
<li>Crypto Express 7S CCA coprocessor (CEX7C) or later for CCA type keys</li>
<li>Crypto Express 7S EP11 coprocessor (CEX7P) or later for EP11 type keys</li>
<li>CCA host library version 7.1 or later for CCA type keys</li>
<li>EP11 host library version 3.0 or later for EP11 type keys</li>
</ul>
<p>Additional hardware and software prerequisites for full-XTS:</p><ul>
<li>Message security assist (MSA) 10 (IBM z17 or later)</li>
<li>A KVM guest in IBM Secure Execution mode for PVSECRET type keys</li>
<li>Kernel 6.13 or later with support for PVSECRET type keys</li>
</ul>
<p>Additional hardware and software prerequisites for HMAC:</p><ul>
<li>Message security assist (MSA) 11 (IBM z17 or later)</li>
<li>A KVM guest in IBM Secure Execution mode for PVSECRET type keys</li>
<li>Kernel 6.13 or later with support for PVSECRET type keys</li>
</ul>
<p>Building <code>libzpc</code>: </p><pre class="fragment">mkdir build &amp;&amp; cd build
cmake ..
make
</pre><p> The following options can be passed to <code>cmake</code>:</p><ul>
<li><code>-DCMAKE_INSTALL_PREFIX=&lt;path&gt;</code> : Change the install prefix from <code>/usr/local/</code> to <code>&lt;path&gt;</code>.</li>
<li><code>-DCMAKE_BUILD_TYPE=&lt;type&gt;</code> : Choose predefined build options. The choices for <code>&lt;type&gt;</code> are <code>Debug</code>, <code>Release</code>, <code>RelWithDebInfo</code>, and <code>MinSizeRel</code>.</li>
<li><code>-DBUILD_SHARED_LIBS=ON</code> : Build a shared object (instead of an archive).</li>
<li><code>-DBUILD_TEST=ON</code> : Build the test program.</li>
<li><code>-DBUILD_DOC=ON</code> : Build the html and latex doc.</li>
</ul>
<p>See <code>cmake(1)</code>.</p>
<p>Custom compile options can also be passed to <code>cmake</code> via the <code>CFLAGS</code> and <code>CXXFLAGS</code> environment variables in the usual way.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Testing</h1>
<p>To run all tests, do </p><pre class="fragment">./runtest
</pre><p> from the build directory.</p>
<p>For AES, the following environment variables can be passed to <code>./runtest</code>:</p><ul>
<li><code>ZPC_TEST_AES_KEY_TYPE=&lt;type&gt;</code> : The choices for <code>&lt;type&gt;</code> are <code>ZPC_AES_KEY_TYPE_CCA_DATA</code>, <code>ZPC_AES_KEY_TYPE_CCA_CIPHER</code> and <code>ZPC_AES_KEY_TYPE_EP11</code>. AES tests are skipped if this variable is unset or its value is invalid.</li>
<li><code>ZPC_TEST_AES_KEY_SIZE=&lt;size&gt;</code> : The choices for <code>&lt;size&gt;</code> are <code>128</code>, <code>192</code> and <code>256</code>. AES tests are skipped if this variable is unset or its value is invalid.</li>
<li><code>ZPC_TEST_AES_KEY_FLAGS=&lt;flags&gt;</code> : <code>&lt;flags&gt;</code> is a 4 byte unsigned integer value that specifies the key's flags. <code>&lt;flags&gt;</code> defaults to <code>0</code> if this variable is unset or its value is invalid.</li>
<li><code>ZPC_TEST_AES_KEY_MKVP=&lt;mkvp&gt;</code> : Test the APQNs that match <code>&lt;mkvp&gt;</code> and key type.</li>
<li><code>ZPC_TEST_AES_KEY_APQNS=&lt;apqns&gt;</code> : Test the <code>&lt;apqns&gt;</code>.</li>
</ul>
<p>For AES-XTS when using full-XTS keys, the following environment variables can be passed to <code>./runtest</code>:</p><ul>
<li><code>ZPC_TEST_AES_XTS_KEY_TYPE=&lt;type&gt;</code> : The only supported choice for <code>&lt;type&gt;</code> is <code>ZPC_AES_XTS_KEY_TYPE_PVSECRET</code>.</li>
<li><code>ZPC_TEST_AES_XTS_KEY_SIZE=&lt;size&gt;</code> : The choices for <code>&lt;size&gt;</code> are <code>128</code>, and <code>256</code>. AES full-XTS tests are skipped if this variable is unset or its value is invalid. The pvsecret_kat test compares the results from using one full-XTS key to the results from using two separate AES keys with the same key material. This key material must be added to the pvsecret list file. When this key material is available in the pvsecret list file, also specify</li>
<li><code>ZPC_TEST_AES_KEY_TYPE=&lt;type&gt;</code> and</li>
<li><code>ZPC_TEST_AES_KEY_APQNS=&lt;apqns&gt;</code> or <code>ZPC_TEST_AES_KEY_MKVP=&lt;mkvp&gt;</code>.</li>
</ul>
<p>For ECDSA, the following environment variables can be passed to <code>./runtest</code>:</p><ul>
<li><code>ZPC_TEST_EC_KEY_TYPE=&lt;type&gt;</code> : The choices for <code>&lt;type&gt;</code> are <code>ZPC_EC_KEY_TYPE_CCA</code> and <code>ZPC_EC_KEY_TYPE_EP11</code>. ECDSA tests are skipped if this variable is unset or its value is invalid.</li>
<li><code>ZPC_TEST_EC_KEY_CURVE=&lt;curve&gt;</code> : The choices for <code>&lt;curve&gt;</code> are <code>p256</code> (prime256), <code>p384</code> (secp384), <code>p521</code> (secp521), <code>ed25519</code> (ed25519) and <code>ed448</code> (ed448). ECDSA tests are skipped if this variable is unset or its value is invalid.</li>
<li><code>ZPC_TEST_EC_KEY_FLAGS=&lt;flags&gt;</code> : <code>&lt;flags&gt;</code> is a 4 byte unsigned integer value that specifies the key's flags. <code>&lt;flags&gt;</code> defaults to <code>0</code> if this variable is unset or its value is invalid.</li>
<li><code>ZPC_TEST_EC_KEY_MKVP=&lt;mkvp&gt;</code> : Test the APQNs that match <code>&lt;mkvp&gt;</code> and key type.</li>
<li><code>ZPC_TEST_EC_KEY_APQNS=&lt;apqns&gt;</code> : Test the <code>&lt;apqns&gt;</code>.</li>
</ul>
<p>For HMAC, the following environment variables can be passed to <code>./runtest</code>:</p><ul>
<li><code>ZPC_TEST_HMAC_KEY_TYPE=&lt;type&gt;</code> : The only supported choice for <code>&lt;type&gt;</code> is <code>ZPC_HMAC_KEY_TYPE_PVSECRET</code>.</li>
<li><code>ZPC_TEST_HMAC_HASH_FUNCTION=&lt;hfunc&gt;</code> : The choices for <code>&lt;hfunc&gt;</code> are <code>SHA-224</code>, <code>SHA-256</code>, <code>SHA-384</code>, and <code>SHA-512</code>. There are no MKVP or APQN related variables for HMAC.</li>
</ul>
<p>For PVSECRET type keys, the following environment variable must be passed to <code>./runtest</code>:</p><ul>
<li><p class="startli"><code>ZPC_TEST_PVSECRET_LIST_FILE=&lt;list-file&gt;</code> : The <code>&lt;list-file&gt;</code> must be created with the pvsecret utility as part of s390-tools v2.37 or later. Perform a 'pvsecret list' command and redirect the output to the list file. Testers may optionally add clear key data, used when creating Ultravisor retrievable secrets, to the list file. Example:</p>
<p class="startli">7 HMAC-SHA-256-KEY: 0xb620b6d76f89910aff90ff9 ... &lt;- the secret ID 0xa783830e0bd6f3ae8cade16b3004 ... &lt;- the clear key</p>
</li>
</ul>
<p>For PVSECRET type full-XTS keys we have a mixed setting of AES_XTS_KEY and AES_KEY definitions, for example: </p><pre class="fragment">5 AES-XTS-128-KEY:
 0x8ace2a9b ... &lt;- secret ID
 0xbe0274e3f3b363 ... &lt;- clear AES XTS key (2 x 16 bytes)
6 AES-XTS-256-KEY:
 0x2b56938 ... &lt;- secret ID
 0xbf8260655f43 ... &lt;- clear AES XTS key (2 x 32 bytes)
...
</pre><p> If clear key data is available, additional tests (pvsecret_kat) are performed.</p>
<p>See </p><pre class="fragment">./runtest -h
</pre><p> for help.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Installing</h1>
<p>To install the shared library, do </p><pre class="fragment">sudo make install
sudo ldconfig
</pre><h1><a class="anchor" id="autotoc_md4"></a>
Configuration</h1>
<p>To do something useful with <code>libzpc</code>, at least one CryptoExpress (CEX) HSM with a master key configuration is required.</p>
<p>The device drivers for CEX adapters are documented in chapters 54 and 57 of the kernel 5.7 version of <a href="https://www.ibm.com/support/knowledgecenter/linuxonibm/liaaf/lnz_r_dd.html">Linux on Z and LinuxONE - Device Drivers, Features, and Commands</a>.</p>
<p>Here are instructions on <a href="https://www.ibm.com/support/knowledgecenter/linuxonibm/liaaf/lnz_r_dtke.html">how to set an AES master key</a> for a CEX adapter in CCA coprocessor mode using the Trusted Key Entry (TKE).</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Programming</h1>
<p>Applications include the <code>&lt;zpc/...&gt;</code> header files corresponding to the APIs required and link with <code>-lzp</code>.</p>
<p>With the exeption of <code>zpc_error_string</code>, all <code>libzpc</code> function return either no value or an integer which is either zero (in case of success) of a non-zero error code (in case of failure).</p>
<p>In case of multiple errors, the <code>libzpc</code> API leaves the precedence of error codes undefined. Therefore, applications should always check for a non-zero return value before handling specific errors e.g.: </p><pre class="fragment">rc = zpc_foo();
if (rc) {
    /* Handle specific error codes. */
    fprintf(stderr, "Error: %d (%s).\n", rc, zpc_error_string(rc));
}
</pre><h1><a class="anchor" id="autotoc_md6"></a>
Debugging</h1>
<p>Setting the environment variable <code>ZPC_DEBUG=1</code> will have the library print debug information to <code>stderr</code>.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
License</h1>
<p>See <code>LICENSE</code> file. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
